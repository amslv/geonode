{% extends "geonode_base.html" %}
{% load i18n %}
{% load static from staticfiles %}

{% block body_outer %}

<!-- TODO download this css (Issue 1) -->
<link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css">
<!-- TODO put in other file (Issue 2) -->
<style>

    @font-face {
      font-family: qanelas-bold;
      src: url(../static/lib/font/qanelas-bold.otf);
      font-weight: bold;
    }

    .container {
      width: 90% !important;
    }

    .map {
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: block;
      position: relative;
    }

    .chart {
      margin-top: 10%;
    }

    .content {
      width: 100%;
      height: 500px;
      padding: 10px;
      /* font-family: qanelas-bold;       */
    }

    .container-chart {
      float: left;
      width: 40%;
      overflow: hidden;
    }

    .container-map {
      float: right;
      width: 60%;
      position: relative;
    }
    .crumbs {
      min-height: 15px;
    }

    .crumbs .crumb {
      position: relative;
      padding: 12px;
      font-family: qanelas-bold;
    }

    .crumbs .crumb:not(:last-of-type):before {
      content: "";
      display: block;
      position: absolute;
      border-top: 4px solid transparent;
      border-left: 6px solid #658ed0;
      border-bottom: 4px solid transparent;
      top: 18px;
      right: -5px;
    }

    .container-description {   
      width: 65%;
      overflow: inherit;
      float: left;
      height: 100%;
      margin-top: 10px;
      padding: 10px;     
      border-right: 1px solid lightgray;  
      position: relative;
    }    

    .container-legend {  
      min-width: 100px;
      width: 25%;
      height: 100%;
      margin: 5px;
      margin: 10px;
      padding: 5px;
      font-size: 14px;
      float: right;
      position: relative;
    }

    .container-legend label {
      display: block;
    }

    .container-description-row {      
      display: inline-block;
    }

    .container-description-row-content {
      float: left;
    }

    .container-description-row {
      font-size: 14px;
    }

    .row {
      padding-left: 3%;
    }

    .panel {
      border: 0;
    }

    .breadcrumb {
      background: rgb(219, 219, 219);
      border: 0px solid rgba(219, 219, 219);
      border-radius: 6px;
      display: block;
      padding: 10px;
    }

    .breadcrumb li {
      font-size: 14px;
    }

    .breadcrumb a {
      color: rgba(66, 139, 202, 1);
    }

    .breadcrumb a:hover {
      color: rgba(42, 100, 150, 1);
    }

    .breadcrumb>.active {
      color: rgba(153, 153, 153, 1);
    }

    .breadcrumb>li+li:before {
      color: rgba(204, 204, 204, 1); content: "\002F\00a0";
    }

    .loader {
      border: 5px solid #f3f3f3;
      border-radius: 50%;
      border-top: 5px solid #3498db;
      width: 32px;
      height: 32px;
      -webkit-animation: spin 1.5s linear infinite; /* Safari */
      animation: spin 1.5s linear infinite;
      margin: 2px;
      float: right;
      z-index: 999;
      position: absolute;
      right: 10px;
      top: 10px;
    }    

    .loader2 {
      border: 4px solid #f3f3f3;
      border-radius: 50%;
      border-top: 4px solid #3498db;
      width: 18px;
      height: 18px;
      -webkit-animation: spin 1.5s linear infinite; /* Safari */
      animation: spin 1.5s linear infinite;
      margin: 2px;
      float: right;
      z-index: 999;
      position: absolute;
      right: 2px;
      top: 2px;
    }       

    .advanced-button-control {
      background-color: rgba(255,255,255,.4);
      border-radius: 4px;
      padding: 2px; 
      position: absolute;
      font-size: 1.14em;
      left: .47em;
      top: 6.4em;           
      z-index: 999;
      width: 1.9em;
      height: 1.9em;      
    }

    .advanced-button {
      background-color: rgba(0,60,136,.5);      
      background-image: url("data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIj8+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjE2cHgiIHZpZXdCb3g9IjAgMCA1MTIuMDAwMDMgNTEyIiB3aWR0aD0iMTZweCI+PHBhdGggZD0ibTUwNi42MzI4MTIgMzE2LjMyMDMxMmMtMy4yNTM5MDYtMS4yOTI5NjgtNi45Njg3NS0uNDg0Mzc0LTkuMzg2NzE4IDIuMDQ2ODc2bC0zNi40NDUzMTMgMzguMzA4NTkzdi0yMjcuNTQyOTY5aC4wNDI5NjlsMzQuNzczNDM4LTM3LjU0Njg3NGMzLjE5OTIxOC0zLjQ1NzAzMiAyLjk4ODI4MS04Ljg1OTM3Ni0uNDcyNjU3LTEyLjA1ODU5NCAwIDAtLjAwMzkwNi0uMDAzOTA2LS4wMDc4MTItLjAwNzgxM2wtMTIuNTE1NjI1LTExLjY0ODQzNyAxNy4zOTA2MjUtMTguNzczNDM4YzMuMTk1MzEyLTMuNDYwOTM3IDIuOTgwNDY5LTguODU5Mzc1LS40ODA0NjktMTIuMDU0Njg3bC0zNy41NDY4NzUtMzQuNzczNDM4Yy0zLjQ1NzAzMS0zLjE5OTIxOS04Ljg1NTQ2OS0yLjk5MjE4Ny0xMi4wNTQ2ODcuNDY4NzVsLTYwLjY3MTg3NiA2NS41MTE3MTloLTI5NS4zOTA2MjRjLS4wMjczNDQtMjMuNTU0Njg4LTE5LjExMzI4Mi00Mi42NDA2MjUtNDIuNjY3OTY5LTQyLjY2Nzk2OWgtOC41MzEyNWMtMjMuNTU0Njg4LjAyNzM0NC00Mi42NDA2MjUyIDE5LjExMzI4MS00Mi42Njc5NjkgNDIuNjY3OTY5djM2Ni45MzM1OTRjMCA0LjcxMDkzNyAzLjgyMDMxMiA4LjUzMTI1IDguNTM1MTU2IDguNTMxMjVoMTI5LjE3NTc4MmwtMTcuOTIxODc2IDIxLjUxOTUzMWMtMy4wMTE3MTggMy42MjUtMi41MTk1MzEgOS4wMDM5MDYgMS4xMDE1NjMgMTIuMDE1NjI1bDM5LjM0NzY1NiAzMi43NjE3MTljMy42MjEwOTQgMy4wMTU2MjUgOS4wMDM5MDcgMi41MjM0MzcgMTIuMDE5NTMxLTEuMDk3NjU3IDAgMCAuMDAzOTA3LS4wMDM5MDYuMDAzOTA3LS4wMDM5MDZsNDMuNjc1NzgxLTUyLjQ3MjY1NmMzLjAxNTYyNS0zLjYzMjgxMiA0Ljk1NzAzMS04LjA0Mjk2OSA1LjU5NzY1Ni0xMi43MjI2NTZoMTU2LjM2MzI4MmwtNTEuMjg1MTU3IDUzLjg1NTQ2OGMtMy4yNDYwOTMgMy40MTQwNjMtMy4xMDkzNzUgOC44MTY0MDcuMzA0Njg4IDEyLjA2MjUgMS41ODU5MzcgMS41MDc4MTMgMy42OTE0MDYgMi4zNTE1NjMgNS44ODI4MTIgMi4zNDc2NTdoMTcwLjY2NDA2M2M0LjcxNDg0NCAwIDguNTM1MTU2LTMuODIwMzEzIDguNTM1MTU2LTguNTMxMjV2LTE3OS4xOTkyMTljMC0zLjQ5MjE4OC0yLjEyNS02LjYzMjgxMi01LjM2NzE4OC03LjkyOTY4OHptLTI5LjMzNTkzNy0yMzAuMTUyMzQzLTE2LjQ5NjA5NCAxNy44NDM3NXYtMTIuNTUwNzgxbDEwLjIzODI4MS0xMS4wOTM3NXptLTMzLjU2MjUtMS41MTk1MzF2LjEyMTA5M2wtNzIuMTY3OTY5IDc3Ljk5NjA5NC0yNS4wNjI1LTIzLjE4NzUgODYuOTM3NS05My45NTMxMjUgMjUuMDYyNSAyMy4xODc1LTE0LjY2Nzk2OCAxNS44MzU5Mzh6bS04OC41NTg1OTQgODYuMTg3NS0xOS42Mjg5MDYgNS43MjY1NjIgNC4xOTE0MDYtMjAuMDE5NTMxem0xMDEuNDUzMTI1LTE1MC4yNjE3MTkgMjUuMDUwNzgyIDIzLjE3NTc4MS0xMS41OTM3NSAxMi41NTA3ODEtMjUuMDU0Njg4LTIzLjE5OTIxOXptLTQxMy45NjA5MzcgMjIuMDc0MjE5aDguNTMxMjVjMTQuMTQwNjI1IDAgMjUuNjAxNTYyIDExLjQ2MDkzNyAyNS42MDE1NjIgMjUuNjAxNTYydjMyNC40ODgyODFjLTcuMzQzNzUtNS42NDg0MzctMTYuMzM5ODQzLTguNzI2NTYyLTI1LjYwMTU2Mi04Ljc1NzgxMmgtOC41MzEyNWMtOS4yNjU2MjUuMDMxMjUtMTguMjU3ODEzIDMuMTA5Mzc1LTI1LjYwMTU2MyA4Ljc1NzgxMnYtMzI0LjQ4ODI4MWMwLTE0LjE0MDYyNSAxMS40NjA5MzgtMjUuNjAxNTYyIDI1LjYwMTU2My0yNS42MDE1NjJ6bTAgMzU4LjM5ODQzN2g4LjUzMTI1YzE0LjE0MDYyNSAwIDI1LjYwMTU2MiAxMS40NjQ4NDQgMjUuNjAxNTYyIDI1LjYwMTU2M2gtNTkuNzM0Mzc1YzAtMTQuMTM2NzE5IDExLjQ2MDkzOC0yNS42MDE1NjMgMjUuNjAxNTYzLTI1LjYwMTU2M3ptMTYwLjE2MDE1NiA0NC40NzY1NjMtNS40NjA5MzcgNi41NTQ2ODctMjYuMjMwNDY5LTIxLjgzNTkzNyA1LjQ1MzEyNS02LjU2MjVjMy4wMTU2MjUtMy42MjEwOTQgOC4zOTQ1MzEtNC4xMTMyODIgMTIuMDE1NjI1LTEuMDk3NjU3LjAwMzkwNiAwIC4wMDM5MDYuMDAzOTA3LjAwNzgxMi4wMDM5MDdsMTMuMTEzMjgxIDEwLjg5MDYyNGMzLjYyNSAzLjAxMTcxOSA0LjEyMTA5NCA4LjM5MDYyNiAxLjEwOTM3NiAxMi4wMTU2MjYtLjAwMzkwNy4wMDM5MDYtLjAwMzkwNy4wMDM5MDYtLjAwNzgxMy4wMDc4MTJ6bS0zOC4yMTg3NSA0NS45MTAxNTYtMjYuMjM0Mzc1LTIxLjgzNTkzOCAyMS44Mzk4NDQtMjYuMjQyMTg3IDI2LjIzMDQ2OCAyMS44Mzk4NDN6bTUzLjMzOTg0NC02NC43ODUxNTZjLTEuNDE3OTY5LTIuMzYzMjgyLTMuMjEwOTM4LTQuNDc2NTYzLTUuMzA4NTk0LTYuMjYxNzE5bC0xMy4xMTMyODEtMTAuOTE0MDYzYy0xMC44NjcxODgtOS4wNDY4NzUtMjcuMDA3ODEzLTcuNTc0MjE4LTM2LjA1NDY4OCAzLjI5Mjk2OWwtMTEuNTc4MTI1IDEzLjg4MjgxM2gtNTguMDI3MzQzdi0zNDEuMzMyMDMyaDI3OS42MDE1NjJsLTQ1LjI4NTE1NiA0OC45Mzc1Yy0uNjQ4NDM4LjczMDQ2OS0xLjE2NDA2MyAxLjU3NDIxOS0xLjUxOTUzMiAyLjQ4NDM3NS0uMTAxNTYyLjI0NjA5NC0uMTc5Njg3LjQ3NjU2My0uMjY1NjI0LjczNDM3NS0uMDgyMDMyLjI1MzkwNi0uMjEwOTM4LjUxMTcxOS0uMjczNDM4Ljc4NTE1NmwtMTAuMTg3NSA0OC43MDcwMzJjLS45NjA5MzggNC42MTMyODEgMiA5LjEzMjgxMiA2LjYxMzI4MSAxMC4wOTM3NSAxLjM3MTA5NC4yODUxNTYgMi43ODkwNjMuMjMwNDY4IDQuMTI4OTA3LS4xNjAxNTZsNDcuNzg5MDYyLTEzLjkyNTc4MmMuMjIyNjU2LS4wNzAzMTIuNDEwMTU2LS4xOTkyMTguNjIxMDk0LS4yNzM0MzcuMjE0ODQ0LS4wNzgxMjUuNDM3NS0uMTg3NS42Njc5NjgtLjMwMDc4MS45NTcwMzItLjQzMzU5NCAxLjgyNDIxOS0xLjA0Njg3NiAyLjU1ODU5NC0xLjgwMDc4Mmw2NS40MTc5NjktNzAuNjk5MjE4djI2NC42OTUzMTJsLTQ5LjU3ODEyNSA1Mi4wNTQ2ODh6bTI3Ni45ODQzNzUgNjguMjY1NjI0aC0xNDIuMjI2NTYzbDE0Mi4yMjY1NjMtMTQ5LjMzMjAzMXptMCAwIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0ibTQwMS43MTQ4NDQgNDcyLjU4MjAzMWMxLjMyMDMxMiAzLjE4NzUgNC40MzM1OTQgNS4yNjU2MjUgNy44ODY3MTggNS4yNjU2MjVoNTkuNzMwNDY5YzQuNzE0ODQ0IDAgOC41MzUxNTctMy44MjAzMTIgOC41MzUxNTctOC41MzEyNXYtNTkuNzM0Mzc1YzAtNC43MTQ4NDMtMy44MjQyMTktOC41MzEyNS04LjUzNTE1Ny04LjUzMTI1LTIuMjYxNzE5IDAtNC40MzM1OTMuODk4NDM4LTYuMDMxMjUgMi41bC01OS43MzQzNzUgNTkuNzMwNDY5Yy0yLjQ0MTQwNiAyLjQ0MTQwNi0zLjE3MTg3NSA2LjExMzI4MS0xLjg1MTU2MiA5LjMwMDc4MXptNTkuMDg1OTM3LTQyLjQwMjM0M3YzMC42MDE1NjJoLTMwLjYwMTU2MnptMCAwIiBmaWxsPSIjRkZGRkZGIi8+PHBhdGggZD0ibTM3NS40NjQ4NDQgMzI0LjI1aC01OS43MzA0Njl2LTkzLjg2NzE4OGMtLjAxMTcxOS0yLjI2NTYyNC0uOTE0MDYzLTQuNDM3NS0yLjUxMTcxOS02LjA0Mjk2OGwtNTEuMTk5MjE4LTUxLjE5OTIxOWMtMy4zMzIwMzItMy4zMzIwMzEtOC43MzQzNzYtMy4zMzIwMzEtMTIuMDY2NDA3IDBsLTUxLjE5OTIxOSA1MS4xOTkyMTljLTEuNTg5ODQzIDEuNjA5Mzc1LTIuNDg0Mzc0IDMuNzgxMjUtMi40OTIxODcgNi4wNDI5Njh2OTMuODY3MTg4aC01OS43MzA0NjljLTQuNzE0ODQ0IDAtOC41MzUxNTYgMy44MjAzMTItOC41MzUxNTYgOC41MzEyNSAwIDQuNzE0ODQ0IDMuODIwMzEyIDguNTM1MTU2IDguNTM1MTU2IDguNTM1MTU2aDIzOC45MzM1OTRjNC43MTA5MzggMCA4LjUzMTI1LTMuODIwMzEyIDguNTMxMjUtOC41MzUxNTYgMC00LjcxMDkzOC0zLjgyMDMxMi04LjUzMTI1LTguNTM1MTU2LTguNTMxMjV6bS0xMTkuNDY0ODQ0LTEzMy4wMDM5MDYgMzAuNjAxNTYyIDMwLjYwMTU2MmgtNjEuMjAzMTI0em0tNDIuNjY3OTY5IDQ3LjY2Nzk2OGg4NS4zMzU5Mzh2ODUuMzM1OTM4aC04NS4zMzU5Mzh6bTAgMCIgZmlsbD0iI0ZGRkZGRiIvPjxwYXRoIGQ9Im0yNDcuNDY0ODQ0IDEzNi41MTU2MjVoMTcuMDcwMzEydjE3LjA2NjQwNmgtMTcuMDcwMzEyem0wIDAiIGZpbGw9IiNGRkZGRkYiLz48cGF0aCBkPSJtMjQ3LjQ2NDg0NCAzNTguMzgyODEyaDE3LjA3MDMxMnYxNy4wNjY0MDdoLTE3LjA3MDMxMnptMCAwIiBmaWxsPSIjRkZGRkZGIi8+PC9zdmc+Cg==");
      background-position: 50%;
      background-repeat: no-repeat;
      border: none;
      border-radius: 2px;
      font-size: 1.14em;
      width: 1.3625em;
      height: 1.3625em;      
      margin: 1.3px;
      z-index: 999;
      position: absolute;
      cursor: pointer;
    }

     .advanced-button:hover {
      background-color: #2c689c;
     }

  </style>

<body>
  <div class="content">
    <div id="breadcrumbs" class="crumbs breadcrumb">
        <span class="crumb"></span>
    </div>
    <div id="container-chart" class="container-chart">
      <div id="chart" class="chart"></div>
    </div>
    <div>
    <div class="container-map">
      <div id="map-loader">
        <div class="loader" ></div>
      </div>      
      <div id="map" class="map">
        <div class="advanced-button-control">
          <a id="advanced-button" class="advanced-button button" target="_blank"></a>
        </div>
      </div>
      <div id="container-description" class="container-description">
        <div id="description-loader">
          <div class="loader2" ></div>
        </div>        
        <div class="row">
          <div class="col">
            <div class="container-description-row">
              <label id="container-title-row-content"></label>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col">           
            <div class="container-description-row">                
              <div id="container-description-row-content" class="container-description-row-content"></div>
            </div>
          </div>
        </div>
      </div>
      <div id="container-legend" class="container-legend">
        <div id="legend-loader">
          <div class="loader2" ></div>
        </div>         
        <label>Legenda </label>
        <img id="legend-image">
      </div>
    </div>
  </div>

  {% endblock %}
  {% block extra_script %}
  {% block super %}
  <!-- TODO download this scripts (Issue 1) -->
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
  <script src="../static/lib/js/sunburst-chat-ed.js"></script>
  <script src="../static/lib/js/desertificacao-data.js"></script>
  <script src="//d3js.org/d3.v5.min.js"></script>

  <link href="../static/lib/css/ol-geocoder-ed.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ol-geocoder"></script>  

  <script type="text/javascript">
    // (refactoring) TODO this constants must be setted in another file (Issue 3)    
    const GEOSERVER_URL = 'http://150.165.85.24/geoserver/ows/';
    const DEFAULT_LAYER_OPACITY = 0.85;

    changeAdvancedButton = (imgName) => {
      let url = window.location.protocol + '//' + window.location.hostname + '/maps/new?layer=' + imgName;

      $('#advanced-button').attr("href", url);
    }

    fillLegend = (imgName) => {
      let legendContainerElement = $('#container-legend')
      
      if (imgName == null || imgName === '') {
        legendContainerElement.hide();
        return;
      } else {
        legendContainerElement.show();
      }
      const urlSufix = '?service=wms&request=GetLegendGraphic&format=image%2Fpng&width=20&height=20&layer=' + imgName;

      // show loader
      let legendLoadingElement = $('#legend-loader');
      legendLoadingElement.show();
      
      const url = GEOSERVER_URL + urlSufix;
      let legendElement = $('#legend-image');
      legendElement.attr("src", url);

      legendElement.on("load", () => {
        // hidden loader
        legendLoadingElement.hide();
      });
      legendElement.on("error", () => {
        // hidden loader
        legendLoadingElement.hide();
      });      
    }

    fillBreadcrumbs = (data) => {
      let breadcrumbsArr = getNameArray(data.__dataNode, []);

      let breadcrumbs_container = $("#breadcrumbs");
      
      breadcrumbs_container.empty();
      breadcrumbsArr.reverse().forEach((value) => {
        breadcrumbs_container.append('<span class="crumb">' + value + '</span>');
      });
    }

    getNameArray = (data, array) => {
      array = array || [];
      array.push(data.data.name2);
      if (data.parent) getNameArray(data.parent, array);
      return array;
    };

    fillDescrition = (data) => {      
      let titleContentEl = '#container-title-row-content';
      let descriptionContentEl = '#container-description-row-content';
      $(titleContentEl).text(data.name2 ? data.name2 : '-');
      $(descriptionContentEl).text('');

      let descriptionLoaderElement = $('#description-loader');
      descriptionLoaderElement.show();

      let url = window.location.protocol + '//' + window.location.hostname + '/layers/' + data.imgName + '/metadata_detail_rest';
      $.get(url)
      .done(function (data) {
        $(titleContentEl).text(data.title);
        $(descriptionContentEl).text(data.abstract);
      })
      .fail(function (error) {
        $(titleContentEl).text(data.name2 ? data.name2 : '-');
        $(descriptionContentEl).text('');
      })
      .always(function() {
        descriptionLoaderElement.hide();
      });
    };

    // TODO check. This "Loading" management might become a new js file
    let layersLoadingCount = 0;
    tryStartLoading = () => {
      if (layersLoadingCount <= 0) {
          $('#map-loader').show();
        }
        layersLoadingCount++;
    }

    tryEndLoading = () => {
      layersLoadingCount > 0 && layersLoadingCount--;
      if (layersLoadingCount == 0) {
        $('#map-loader').hide();
      }
    }

    tryForceEndLoading = () => {
      $('#map-loader').hide();
      layersLoadingCount = 0;
    }    
    
    createLayer = (imgName) => {
      layer = new ol.layer.Tile({
        opacity: DEFAULT_LAYER_OPACITY,
        visible: true,
        source: new ol.source.TileWMS({
          url: GEOSERVER_URL,
          params: {
            'LAYERS': imgName,
            'TILED': 'true'
          },
          ratio: 3,
          serverType: "geoserver"
        })
      });

      tryForceEndLoading();
      layer.getSource().on('tileloadstart', function (event) {        
        tryStartLoading();
      });

      layer.getSource().on('tileloadend', function (event) {
        tryEndLoading();
      });

      layer.getSource().on('tileloaderror', function (event) {
        tryEndLoading();
      });

      return layer;
    }

    calculateChartSize = () => {
      const DEFAULT_PERCENT_SIZE = 0.9;
      const DEFAULT_SIZE = 400;
      try {
        return parseInt($("#container-chart").css('width')) * DEFAULT_PERCENT_SIZE;
      } catch (error) {
        return DEFAULT_SIZE;
      }
    };

    stopPeddingRequests = () => {
      window.stop();
    }

    let sunburst;
    $(document).ready(() => {
      let defaultL = new ol.layer.Tile({
        source: new ol.source.OSM()
      });

      const initialImgNameLayer = dataDesertificacao.imgName;
      let rootLayer = createLayer(initialImgNameLayer);

      // TODO (refactoring) put the center parameters in a constant (Issue 4)
      let map = new ol.Map({
        layers: [defaultL, rootLayer],
        target: "map",
        view: new ol.View({
          center: [-4615573.515972, -794945.094166],
          zoom: 5
        })
      });

      let geocoder = new Geocoder('nominatim', {
        provider: 'osm',
        lang: 'pt-BR',
        placeholder: 'Pesquisa por municÃ­pio . . .',
        targetType: 'glass-button',
        limit: 2,
        keepOpen: true
      });

      geocoder.on('addresschosen', function (evt) {        
        map.getView().animate({ zoom: 10, center: evt.coordinate });
        // TODO study who the geocode works
        // to colapse the search field
        $("#map").click();
      });

      map.addControl(geocoder);  

      // TODO analyze this approach, because only works in the page initialization (Issue 5)
      let chartContainerSize = calculateChartSize();

      let color = d3.scaleOrdinal(d3.schemePaired);
      // TODO (refactoring) put the "data" in another file. (Issue 6)
      const DATA_DESERT_ATTR_LABEL = "name2";
      const DATA_DESERT_ATTR_SIZE = "size";
      sunburst = Sunburst()
        .data(dataDesertificacao)
        .label(DATA_DESERT_ATTR_LABEL)
        .size(DATA_DESERT_ATTR_SIZE)
        .width(chartContainerSize)
        .height(chartContainerSize)
        .color((d, parent) => d.color);

      sunburst.onNodeClick(choosenData => {
        stopPeddingRequests();
        map.getLayers().clear();
        sunburst.focusOnNode(choosenData);
        let imgName = choosenData.imgName;
        let layer1 = createLayer(imgName);    

        map.addLayer(defaultL);
        map.addLayer(layer1);
        
        changeAdvancedButton(choosenData.imgName);
        fillBreadcrumbs(choosenData);
        fillLegend(choosenData.imgName);
        fillDescrition(choosenData);
      });

      sunburst($("#chart")[0]);
      
      changeAdvancedButton(initialImgNameLayer);
      fillBreadcrumbs(dataDesertificacao);
      fillLegend(initialImgNameLayer);
      fillDescrition(dataDesertificacao);
    });

    $('#navbar li').on( "click", () => {
      stopPeddingRequests();
    });    

    let resizing = false;
    $(window).on('resize', function(){
      const RESIZING_TIMEOUT = 1000;
      if (!resizing) {
        resizing = true;
        setTimeout(() => {          
          let chartContainerSize = calculateChartSize();
          sunburst.width(chartContainerSize);
          sunburst.height(chartContainerSize);
          $("#chart").html('');
          sunburst($("#chart")[0]);
          resizing = false;          
        }, RESIZING_TIMEOUT);
      }
    });    

  </script>
  {% endblock super %}
  {% endblock extra_script %}