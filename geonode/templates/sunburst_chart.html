{% extends "geonode_base.html" %}
{% load i18n %}
{% load static from staticfiles %}

{% block body_outer %}
  <!-- TODO download this css (Issue 1) -->
  <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css">

  <!-- TODO put in other file (Issue 2) -->
  <style>
    @import url('https://fonts.googleapis.com/css?family=Lato');
    #map {
      width: 100%;
      height: 100%;
      padding-top: 7%;
      overflow: hidden;
    }

    #chart {
      width: 70%;
      height: 70%;
      padding-left: 10%;
      padding-top: 10%;
    }

    .content {
      width: 100%;
      height: 500px;
      padding: 10px;
    }

    .container-chart {
      float: left;
      width: 40%;
      overflow: hidden;
    }

    .container-map {
      float: right;
      width: 60%;
    }
    .crumbs {
      min-height: 15px;
    }

    .crumbs .crumb {
      position: relative;
      display: inline-block;
      padding: 12px;
      font-family: 'Lato', sans-serif;
      font-weight: bold;
      font-size: 14px;
    }

    .crumbs .crumb:not(:last-of-type):before {
      content: "";
      display: block;
      position: absolute;
      border-top: 4px solid transparent;
      border-left: 6px solid #658ed0;
      border-bottom: 4px solid transparent;
      top: 21px;
      right: -5px;
    }

    .container-description {
      width: 100%;
      visibility: hidden;
      padding: 10px;
      overflow: hidden;
      margin-top: 5%;
    }    

    .container-description-row {      
      display: inline-block;
    }

    .container-description-row-content {
      float: left;
    }

    .row {
      padding-left: 3%;
    }

    .panel {
      border: 0;
    }

    .breadcrumb {
      background: rgb(238, 238, 238);
      border: 0px solid rgba(245, 245, 245, 1);
      border-radius: 6px;
      display: block;
    }
    .breadcrumb li {
      font-size: 14px;
    }
    .breadcrumb a {
      color: rgba(66, 139, 202, 1);
    }
    .breadcrumb a:hover {
      color: rgba(42, 100, 150, 1);
    }
    .breadcrumb>.active {
      color: rgba(153, 153, 153, 1);
    }
    .breadcrumb>li+li:before {
      color: rgba(204, 204, 204, 1); content: "\002F\00a0";
    }

  </style>
  
  <body>
    <div class="content">
        <div class="row">
          <div id="breadcrumbs" class="crumbs breadcrumb"></div>
        </div>
        <div id="container-chart" class="container-chart">
          <div id="chart" class="chart"></div>
        </div>
        <div class="container-map">
          <div id="map" class="map"></div>
        </div>
      </div>
      <div class="container">
        <div class="panel panel-default">
            <div class="panel-body">
                <div id="container-description" class="container-description">
                    <div class="row">
                        <div class="col">
                            <div class="container-description-row">
                              <div class="container-description-row-content">
                                Lorem, ipsum dolor sit amet consectetur adipisicing elit.
                                Nostrum labore deserunt, quaerat maxime iste doloribus dolores aperiam ipsa facere
                                perferendis repellat quibusdam recusandae incidunt animi vero sint voluptate sapiente dolorem!
                              </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                      <div class="col">
                          <div class="container-description-row">
                            <label class="container-description-row-content">Para saber mais sobre o assunto:&nbsp</label>
                            <a id="container-description-doc" class="container-description-row-content" href="" target="_blank">Documento</a>
                          </div>
                      </div>
                    </div>
                </div>
              </div>
          </div>
      </div>
{% endblock %}

{% block extra_script %}
{% block super %}
  <!-- TODO download this scripts (Issue 1) -->
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
  <script src="//unpkg.com/sunburst-chart"></script>
  <script src="//d3js.org/d3.v5.min.js"></script>

  <script type="text/javascript">
    // (refactoring) TODO this constants must be setted in another file (Issue 3)
    const GEOSERVER_URL = 'http://150.165.85.24/geoserver/wms/';

    // (refactoring) TODO put in another file (Issue 6)
    const dataDesertificacao = {
          name: "Desertificação",
          imgName: "geonode:aedm_1",
          description: "geonode:aedm_1 ...",
          linkDocumentation: "http://google.com?anything=geonode:aedm_1",
          children: [
            {
              name: "Estado",
              imgName: "geonode:dprur_wgs",
              description: "geonode:dprur_wgs ...",
              linkDocumentation: "http://google.com?anything=geonode:dprur_wgs",              
              size: 2,
              children: [
                {
                  name: "Condição Ambiental",
                  size: 3.3,                
                  imgName: "geonode:aernp",
                  description: "geonode:aernp ...",
                  linkDocumentation: "http://google.com?anything=geonode:geonode:aernp",                      
                  children: [
                    {
                      name: "Indice de Aridez",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    },
                    {
                      name: "Indice de Seca",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    },
                    {
                      name: "Cobertura Vegetal",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    },
                    {
                      name: "Grau de Fertilidade do Solo",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      imgName: "geonode:uapha",
                      size: 3.3
                    },
                    {
                      name: "Risco de Erosão Hidrica",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    }
                  ]
                },
                {
                  name: "Condição Econômica",
                  size: 3.3,
                  imgName: "geonode:afagp_1",
                  description: "geonode:afagp_1 ...",
                  linkDocumentation: "http://google.com?anything=geonode:geonode:afagp_1",     
                  children: [
                    {
                      name: "Renda Per Capita Rural",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    },
                    {
                      name: "Produtividade do Feijão",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    },
                    {
                      name: "Produtividade do Milho",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    }
                  ]
                },
                {
                  name: "Condição Social",
                  size: 3.3,
                  imgName: "geonode:analf",
                  description: "geonode:analf ...",
                  linkDocumentation: "http://google.com?anything=geonode:geonode:analf",                  
                  children: [
                    {
                      name: "Densidade de População Rural",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    },
                    {
                      name: "Estabelecimentos Rurais Dirigidos por Mulheres",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    }
                  ]
                }
              ]
            },
            {
              name: "Força Motriz",
              imgName: "geonode:vptr",
              description: "geonode:vptr ...",
              linkDocumentation: "http://google.com?anything=geonode:geonode:vptr",                 
              size: 2,
              children: [
                {
                  name: "Concentração de Terra",
                  size: 3.3,
                  imgName: "geonode:dprur",
                  description: "...",
                  linkDocumentation: "http://google.com?anything=geonode:...",                        
                  children: [
                    {
                      name:
                        "Área dos estabelecimentos Rurais menores que o modulo fiscal",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                            
                      size: 3.3
                    },
                    {
                      name:
                        "Área dos estabelecimentos Rurais sob regime de não propriedade",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                            
                      size: 3.3
                    }
                  ]
                },
                {
                  name: "Influência da População Urbana",
                  imgName: "geonode:dtsaa_nmin",
                  description: "...",
                  linkDocumentation: "http://google.com?anything=geonode:...",                      
                  size: 3.3
                },
                {
                  name: "Desigualdade Social no Campo",
                  size: 3.3,
                  imgName: "geonode:nogip",
                  description: "...",
                  linkDocumentation: "http://google.com?anything=geonode:...",                      
                  children: [
                    {
                      name: "Analfabetismo no Campo",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    },
                    {
                      name: "População rural abaixo da linha de pobreza",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    }
                  ]
                }
              ]
            },
            {
              name: "Resposta",
              imgName: "geonode:nong",
              description: "...",
              linkDocumentation: "http://google.com?anything=geonode:...",                  
              size: 2,
              children: [
                {
                  name: "Organização da Sociedade Civil",
                  description: "...",
                  linkDocumentation: "http://google.com?anything=geonode:...",                      
                  size: 2
                },
                {
                  name: "Organização do Poder Público",
                  description: "...",
                  linkDocumentation: "http://google.com?anything=geonode:...",                      
                  size: 2
                }
              ]
            },
            {
              name: "Impacto",
              imgName: "geonode:npdrs",
              description: "...",
              linkDocumentation: "http://google.com?anything=geonode:...",                  
              size: 2,
              children: [
                {
                  name: "Taxa de Migração do Campo para a Cidade",
                  description: "...",
                  linkDocumentation: "http://google.com?anything=geonode:...",                      
                  size: 5
                },
                {
                  name: "Variação da Participação da Agropecuária no PIB",
                  description: "...",
                  linkDocumentation: "http://google.com?anything=geonode:...",                      
                  size: 5
                }
              ]
            },
            {
              name: "Pressão",
              imgName: "geonode:npuc",
              description: "...",
              linkDocumentation: "http://google.com?anything=geonode:...",    
              size: 2,
              children: [
                {
                  name: "Desmatamento",
                  size: 5,
                  imgName: "geonode:pralp",
                  description: "...",
                  linkDocumentation: "http://google.com?anything=geonode:...",                      
                  children: [
                    {
                      name: "Avanço da fronteira agropecuária",
                      imgName: "geonode:vpr_10",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    },
                    {
                      name: "Mudança da cobertura vegetal",
                      imgName: "geonode:rpcr",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    }
                  ]
                },
                {
                  name: "Manejamento Inadequado da Terra",
                  size: 5,
                  imgName: "geonode:rctf2006mm",
                  description: "...",
                  linkDocumentation: "http://google.com?anything=geonode:...",                      
                  children: [
                    {
                      name: "Carga animal excessiva",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    },
                    {
                      name: "Recorrência de Incêndio",
                      description: "...",
                      linkDocumentation: "http://google.com?anything=geonode:...",                          
                      size: 3.3
                    }
                  ]
                }
              ]
            }
          ]
        };

    let fillBreadcrumbs = (data) => {
      let breadcrumbsArr = getNameArray(data.__dataNode, []);

      let breadcrumbs_container = $("#breadcrumbs");
      breadcrumbs_container.empty();

      breadcrumbsArr.reverse().forEach((value) => {
        breadcrumbs_container.append('<span class="crumb">' + value + '</span>');
      });
    }

    let getNameArray = (data, array) => {
      array = array || [];
      array.push(data.data.name);
      if (data.parent) getNameArray(data.parent, array);
      return array;
    };

    let showDescrition = (data) => {
      $('#container-description').css('visibility', 'visible');
      $('#container-description-name').text(data.name ? data.name : '-');
      $('#container-description-descrip').text(data.description ? data.description : '-');
      $('#container-description-doc')
                  .attr("href", data.linkDocumentation ? data.linkDocumentation : '-');
    };

    let calculateChartSize = () => {
      const DEFAULT_PERCENT_SIZE = 0.7;
      const DEFAULT_SIZE = 400;
      try {
        return parseInt($("#container-chart").css('width')) * DEFAULT_PERCENT_SIZE;
      } catch (error) {
        return DEFAULT_SIZE;
      }
    };

    $(document).ready(() => {
      let defaultL = new ol.layer.Tile({
        source: new ol.source.OSM()
      });

      // TODO (refactoring) put the center parameters in a constant (Issue 4)
      let map = new ol.Map({
        layers: [defaultL],
        target: "map",
        view: new ol.View({
          center: [-4615573.515972, -794945.094166],
          zoom: 4
        })
      });

      // TODO analyze this approach, because only works in the page initialization (Issue 5)
      let chartContainerSize = calculateChartSize();

      let color = d3.scaleOrdinal(d3.schemePaired);
      // TODO (refactoring) put the "data" in another file. (Issue 6)
      const DATA_DESERT_ATTR_LABEL = "name";
      const DATA_DESERT_ATTR_SIZE = "size";
      let sunburst = Sunburst()
        .data(dataDesertificacao)
        .label(DATA_DESERT_ATTR_LABEL)
        .size(DATA_DESERT_ATTR_SIZE) 
        .width(chartContainerSize)
        .height(chartContainerSize)
        .color((d, parent) => color(parent ? parent.data.name : null));

      sunburst.onNodeClick(choosenData => {
        map.getLayers().clear();
        sunburst.focusOnNode(choosenData);
        var layer1 = new ol.layer.Image({
          source: new ol.source.ImageWMS({
            url: GEOSERVER_URL,
            params: { LAYERS: choosenData.imgName },
            ratio: 1,
            serverType: "geoserver"
          })
        });
        map.addLayer(defaultL);
        map.addLayer(layer1);

        fillBreadcrumbs(choosenData);
        showDescrition(choosenData);
      });

      sunburst($("#chart")[0]);
    });

  </script>
{% endblock super %}
{% endblock extra_script %}